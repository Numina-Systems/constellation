# Bluesky DataSource â€” Test Requirements

Generated from: docs/design-plans/2026-02-27-bsky-datasource.md

## Automated Tests

| AC ID | Description | Test Type | Expected Test File | Phase |
|-------|------------|-----------|-------------------|-------|
| bsky-datasource.AC1.1 | DataSource connects to Jetstream and receives `app.bsky.feed.post` events | unit | src/extensions/bluesky/source.test.ts | 2 |
| bsky-datasource.AC1.2 | Posts from DIDs in `watched_dids` are passed to the message handler | unit | src/extensions/bluesky/source.test.ts | 2 |
| bsky-datasource.AC1.3 | Replies to the agent's own `did` are passed to the message handler (regardless of author DID) | unit | src/extensions/bluesky/source.test.ts | 2 |
| bsky-datasource.AC1.4 | Posts from DIDs not in `watched_dids` and not replies to agent are filtered out | unit | src/extensions/bluesky/source.test.ts | 2 |
| bsky-datasource.AC1.5 | IncomingMessage metadata contains platform, did, handle, uri, cid, rkey, and reply_to | unit | src/extensions/bluesky/source.test.ts | 2 |
| bsky-datasource.AC1.6 | BskyAgent session is established on connect, access/refresh tokens are accessible via getter methods | unit | src/extensions/bluesky/source.test.ts | 2 |
| bsky-datasource.AC2.1 | `processEvent()` creates/reuses a dedicated Bluesky conversation distinct from REPL | unit | src/agent/agent.test.ts | 3 |
| bsky-datasource.AC2.2 | Event is formatted as a structured message with author DID/handle, post URI/CID, reply context, and post text | unit | src/agent/agent.test.ts | 3 |
| bsky-datasource.AC2.4 | Bluesky conversation persists across daemon restarts (deterministic conversation_id) | unit | src/agent/agent.test.ts | 3 |
| bsky-datasource.AC3.1 | Sandbox executions from Bluesky conversation receive BSKY_SERVICE, BSKY_ACCESS_TOKEN, BSKY_REFRESH_TOKEN, BSKY_DID, BSKY_HANDLE as constants | unit | src/runtime/executor.test.ts | 4 |
| bsky-datasource.AC3.2 | Sandbox executions from REPL conversation do not receive Bluesky credentials | unit | src/runtime/executor.test.ts | 4 |
| bsky-datasource.AC3.3 | Injected constants are valid JavaScript/TypeScript that can be referenced by agent-written code | unit | src/runtime/executor.test.ts | 4 |
| bsky-datasource.AC4.1 | `[bluesky]` section in config.toml parses with all fields | unit | src/config/schema.test.ts | 1 |
| bsky-datasource.AC4.2 | Config validation fails when `enabled: true` but required fields missing | unit | src/config/schema.test.ts | 1 |
| bsky-datasource.AC4.3 | `BLUESKY_HANDLE` env var overrides `bluesky.handle` in TOML | unit | src/config/config.test.ts | 1 |
| bsky-datasource.AC4.4 | `BLUESKY_APP_PASSWORD` env var overrides `bluesky.app_password` in TOML | unit | src/config/config.test.ts | 1 |
| bsky-datasource.AC4.5 | `watched_dids` can be empty (agent only receives replies to own account) | unit | src/config/schema.test.ts | 1 |
| bsky-datasource.AC4.6 | Feature is entirely disabled when `enabled: false` or `[bluesky]` section absent | unit | src/config/schema.test.ts | 1 |
| bsky-datasource.AC5.1 | `bluesky:post`, `bluesky:reply`, `bluesky:like` memory blocks seeded on first run with bluesky enabled | unit | src/extensions/bluesky/seed.test.ts | 5 |
| bsky-datasource.AC5.4 | Re-running with bluesky enabled does not duplicate templates (idempotent) | unit | src/extensions/bluesky/seed.test.ts | 5 |
| bsky-datasource.AC6.2 | Backpressure queue caps at 50 events, drops oldest when full | unit | src/extensions/bluesky/event-queue.test.ts | 6 |
| bsky-datasource.AC6.5 | processEvent errors are logged but do not crash the Jetstream listener | unit | src/index.test.ts | 6 |

## Human Verification

| AC ID | Description | Why Not Automated | Verification Approach |
|-------|------------|-------------------|----------------------|
| bsky-datasource.AC2.3 | Agent can use tools (memory, code execution) during event processing | `processEvent()` delegates to `processMessage()` which already has full tool use coverage in existing tests. The AC asserts architectural passthrough, not new logic. A dedicated test would duplicate existing `processMessage` tool-use tests with no additional signal. | Confirm `processEvent()` calls `processMessage()` directly via code review. Existing `processMessage` tool-use tests in `src/agent/agent.test.ts` already cover the underlying pipeline. |
| bsky-datasource.AC5.2 | Templates are complete, working code examples using `npm:@atproto/api` and injected constants | Templates are static string constants referencing Deno's `npm:` specifier and runtime-injected credential constants. Validating them requires a live Deno subprocess with `@atproto/api` resolved, a mock Bluesky API or real session tokens, and credential constants injected -- effectively an e2e test against the AT Protocol. The cost/complexity ratio is not justified for static template content. | Code review of `src/extensions/bluesky/templates.ts` to verify: (1) each template imports from `npm:@atproto/api`, (2) each template references all five `BSKY_*` injected constants, (3) each template calls `output()` to return results via the sandbox bridge, (4) API calls use correct `AtpAgent` methods (`post`, `like`) per AT Protocol SDK docs. |
| bsky-datasource.AC5.3 | Templates are not seeded when `bluesky.enabled` is false | The `seedBlueskyTemplates()` function itself always seeds unconditionally -- the `enabled` guard lives in the composition root's `if (config.bluesky?.enabled)` branch. Testing this AC requires either an integration test that boots the full composition root with `enabled: false` and asserts no memory writes, or mocking the entire startup sequence. Neither adds meaningful confidence beyond reading the single-line conditional. | Verify the guard in `src/index.ts`: confirm `seedBlueskyTemplates()` is called only inside an `if (config.bluesky?.enabled)` block. No code path invokes it otherwise. |
| bsky-datasource.AC6.1 | Full pipeline: Jetstream event -> DataSource filter -> processEvent -> agent response | True end-to-end: requires a live Jetstream WebSocket connection, a real or mocked Bluesky session, the agent's LLM provider, memory store, and sandbox runtime all wired together. Each individual segment is unit-tested (DataSource filtering in phase 2, processEvent in phase 3, credential injection in phase 4, event queue in phase 6). An automated integration test would require either a Jetstream test harness or extensive mocking that replicates the composition root -- high cost, low marginal confidence over the component tests. | Manual smoke test: (1) configure `config.toml` with `bluesky.enabled = true` and a valid app password, (2) add a test DID to `watched_dids`, (3) start the daemon, (4) post from the watched account, (5) confirm the agent logs show the event received, formatted, and processed, (6) verify the agent produces a response (reply, like, or ignore decision). |
| bsky-datasource.AC6.3 | REPL starts normally even if Jetstream is unreachable | Requires simulating a network-unreachable Jetstream endpoint during the composition root startup sequence. The relevant code is a `try/catch` around `blueskySource.connect()` that logs the error and sets `blueskySource = null`. An automated test would need to either mock the WebSocket constructor to throw or point at a dead URL and wait for the connection timeout, both of which are flaky and slow. | Manual verification: (1) set `jetstream_url` to an unreachable host (e.g., `wss://localhost:1/subscribe`), (2) set `bluesky.enabled = true` with valid credentials, (3) start the daemon, (4) confirm the REPL prompt appears and is interactive, (5) confirm stderr shows the Bluesky connection failure log line. |
| bsky-datasource.AC6.4 | DataSource disconnects cleanly on daemon shutdown | Requires starting the full daemon with a live Bluesky connection and then triggering shutdown (SIGINT/SIGTERM). The shutdown handler calls `blueskySource.disconnect()` inside the existing `shutdownHandler` closure. An automated test would need to orchestrate process lifecycle and inspect the WebSocket state, which is fragile. | Manual verification: (1) start the daemon with Bluesky enabled and connected, (2) send SIGINT (Ctrl+C), (3) confirm stdout shows "bluesky datasource disconnected" before "Shutting down..." completes, (4) confirm no error output related to WebSocket close. |
