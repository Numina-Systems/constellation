# Web Tools Implementation Plan — Phase 5: Tool Definitions and Registration

**Goal:** Wire `web_search` and `web_fetch` as `Tool` objects and register them conditionally in the composition root.

**Architecture:** `createWebTools(searchChain, fetcher)` factory in `src/tool/builtin/web.ts` returns an array of `Tool` objects following the same pattern as `createMemoryTools()` in `src/tool/builtin/memory.ts`. Tools are conditionally registered in `src/index.ts` when `config.web` is defined. IPC bridge stubs are automatically generated by the existing `registry.generateStubs()`.

**Tech Stack:** TypeScript, Bun

**Scope:** 6 phases from original design (phase 5 of 6)

**Codebase verified:** 2026-03-01

---

## Acceptance Criteria Coverage

This phase implements and tests:

### web-tools.AC4: Tools registered and available via IPC bridge
- **web-tools.AC4.1 Success:** web_search and web_fetch appear in registry.getDefinitions() when [web] config exists
- **web-tools.AC4.2 Success:** web_search and web_fetch are absent from registry when [web] config is omitted
- **web-tools.AC4.3 Success:** registry.generateStubs() produces typed IPC bridge functions for both tools

### web-tools.AC5: Configuration and environment overrides
- **web-tools.AC5.1 Success:** BRAVE_API_KEY and TAVILY_API_KEY environment variables override config.toml values

---

<!-- START_SUBCOMPONENT_A (tasks 1-3) -->
<!-- START_TASK_1 -->
### Task 1: Create `src/tool/builtin/web.ts` — web tool definitions

**Verifies:** web-tools.AC4.1, web-tools.AC4.3

**Files:**
- Create: `src/tool/builtin/web.ts`

**Implementation:**

Factory function `createWebTools(searchChain, fetcher)` returns `Array<Tool>`. Follow the exact pattern from `src/tool/builtin/memory.ts` (lines 11-183).

Two tools:

**`web_search`** — delegates to the search chain
- Parameters:
  - `query` (string, required): search query
  - `limit` (number, optional): max results (default from `config.web.max_results`)
- Handler calls `searchChain.search(query, limit)`, returns JSON-stringified `SearchResponse` in `output`
- On error, returns `{ success: false, output: "", error: message }`

**`web_fetch`** — delegates to the fetcher function
- Parameters:
  - `url` (string, required): URL to fetch
  - `continue_from` (number, optional): character offset for pagination (default 0)
- Handler calls `fetcher(url, continueFrom)`, returns JSON-stringified `FetchResult` in `output`
- On error, returns `{ success: false, output: "", error: message }`

The function takes an options object with the search chain, fetcher, and default max results as injected dependencies (same dependency injection pattern as memory tools taking `MemoryManager`):

```typescript
// pattern: Imperative Shell

import type { Tool } from "../types.ts";
import type { SearchResponse, FetchResult } from "../../web/types.ts";

type SearchFn = (query: string, limit: number) => Promise<SearchResponse>;
type FetchFn = (url: string, offset?: number) => Promise<FetchResult>;

type WebToolOptions = {
  readonly search: SearchFn;
  readonly fetcher: FetchFn;
  readonly defaultMaxResults: number;
};

export function createWebTools(
  options: WebToolOptions,
): Array<Tool> {
  const { search, fetcher, defaultMaxResults } = options;
  const web_search: Tool = {
    definition: {
      name: "web_search",
      description: "Search the web and return structured results with title, URL, and snippet for each result.",
      parameters: [
        {
          name: "query",
          type: "string",
          description: "Search query",
          required: true,
        },
        {
          name: "limit",
          type: "number",
          description: `Maximum number of results to return (default ${defaultMaxResults})`,
          required: false,
        },
      ],
    },
    handler: async (params) => {
      const query = params["query"] as string;
      const limit = (params["limit"] as number | undefined) ?? defaultMaxResults;

      try {
        const response = await search(query, limit);
        return {
          success: true,
          output: JSON.stringify(response, null, 2),
        };
      } catch (err) {
        return {
          success: false,
          output: "",
          error: `web search failed: ${err instanceof Error ? err.message : String(err)}`,
        };
      }
    },
  };

  const web_fetch: Tool = {
    definition: {
      name: "web_fetch",
      description: "Fetch a URL and return its content as clean markdown. Supports pagination for large pages via continue_from offset.",
      parameters: [
        {
          name: "url",
          type: "string",
          description: "URL to fetch",
          required: true,
        },
        {
          name: "continue_from",
          type: "number",
          description: "Character offset to continue reading from (for paginated content)",
          required: false,
        },
      ],
    },
    handler: async (params) => {
      const url = params["url"] as string;
      const continueFrom = (params["continue_from"] as number | undefined) ?? 0;

      try {
        const result = await fetcher(url, continueFrom);
        return {
          success: true,
          output: JSON.stringify(result, null, 2),
        };
      } catch (err) {
        return {
          success: false,
          output: "",
          error: `web fetch failed: ${err instanceof Error ? err.message : String(err)}`,
        };
      }
    },
  };

  return [web_search, web_fetch];
}
```

**Verification:**
Run: `bun run build`
Expected: No errors

**Commit:** `feat(web): add web_search and web_fetch tool definitions`
<!-- END_TASK_1 -->

<!-- START_TASK_2 -->
### Task 2: Update `src/tool/index.ts` — export createWebTools

**Files:**
- Modify: `src/tool/index.ts:15` (add export line)

**Step 1: Add export**

Add after line 15 (the `createExecuteCodeTool` export):

```typescript
export { createWebTools } from './builtin/web.ts';
```

**Step 2: Verify build**

Run: `bun run build`
Expected: No errors

**Step 3: Commit**

```bash
git add src/tool/index.ts
git commit -m "feat(web): export createWebTools from tool barrel"
```
<!-- END_TASK_2 -->

<!-- START_TASK_3 -->
### Task 3: Write web tool tests

**Verifies:** web-tools.AC4.1, web-tools.AC4.3

**Files:**
- Create: `src/tool/builtin/web.test.ts`

**Testing:**

Tests use mock search and fetch functions (no HTTP, no real providers). This tests tool definition structure, handler delegation, and error wrapping.

Create mock dependencies:

```typescript
const mockSearch: SearchFn = async (query, limit) => ({
  results: [{ title: "Test", url: "https://example.com", snippet: "A test result" }],
  provider: "mock",
});

const mockFetcher: FetchFn = async (url, offset) => ({
  url,
  title: "Test Page",
  content: "# Test\n\nSome content",
  total_length: 22,
  offset: offset ?? 0,
  has_more: false,
});

const mockOptions: WebToolOptions = {
  search: mockSearch,
  fetcher: mockFetcher,
  defaultMaxResults: 10,
};
```

Tests for each AC:
- **web-tools.AC4.1:** Create tools with `createWebTools()`. Assert array has 2 tools. Assert definitions have correct names (`web_search`, `web_fetch`), descriptions, and parameter schemas.
- **web-tools.AC4.1 (registry):** Register tools in a `createToolRegistry()`. Call `registry.getDefinitions()`. Assert both `web_search` and `web_fetch` are present.
- **web-tools.AC4.3:** Register tools. Call `registry.generateStubs()`. Assert output contains `async function web_search` and `async function web_fetch` with correct parameter signatures.
- **Handler success (search):** Call `web_search` handler with `{ query: "test" }`. Assert `success: true`, output contains JSON with results.
- **Handler success (fetch):** Call `web_fetch` handler with `{ url: "https://example.com" }`. Assert `success: true`, output contains JSON with content.
- **Handler error (search):** Provide a mock search that throws. Assert handler returns `{ success: false, error: "web search failed: ..." }` (doesn't throw).
- **Handler error (fetch):** Provide a mock fetcher that throws. Assert handler returns `{ success: false, error: "web fetch failed: ..." }`.

**Verification:**
Run: `bun test src/tool/builtin/web.test.ts`
Expected: All tests pass

**Commit:** `test(web): add web tool definition and registration tests`
<!-- END_TASK_3 -->
<!-- END_SUBCOMPONENT_A -->

<!-- START_TASK_4 -->
### Task 4: Wire web tools in composition root `src/index.ts`

**Verifies:** web-tools.AC4.2, web-tools.AC5.1

**Files:**
- Modify: `src/index.ts:25` (add imports)
- Modify: `src/index.ts:308` (add conditional registration after `registry.register(createExecuteCodeTool())`)

**Step 1: Add imports**

Add after line 22 (the `createExecuteCodeTool` import):

```typescript
import { createWebTools } from '@/tool/builtin/web';
import { createSearchChain, createFetcher } from '@/web';
```

**Step 2: Add conditional registration**

Insert after line 308 (`registry.register(createExecuteCodeTool())`) and before line 310 (`const runtime = ...`):

```typescript
if (config.web) {
  const searchChain = createSearchChain(config.web);
  const fetcher = createFetcher({
    fetch_timeout: config.web.fetch_timeout,
    max_fetch_size: config.web.max_fetch_size,
    cache_ttl: config.web.cache_ttl,
  });
  const webTools = createWebTools({
    search: (query, limit) => searchChain.search(query, limit),
    fetcher,
    defaultMaxResults: config.web.max_results,
  });
  for (const tool of webTools) {
    registry.register(tool);
  }
  console.log(`web tools registered (providers: ${searchChain.providers.join(", ")})`);
}
```

This follows the exact conditional registration pattern used for Bluesky (lines 316-329). The `config.web` check means tools are only registered when the `[web]` section exists in config (satisfying AC4.2).

Environment variable overrides (AC5.1) are handled by `src/config/config.ts` (Phase 1, Task 4) — `BRAVE_API_KEY` and `TAVILY_API_KEY` env vars are merged into the config before it reaches this code.

**Step 3: Verify build**

Run: `bun run build`
Expected: No errors

**Step 4: Verify existing tests still pass**

Run: `bun test`
Expected: All previously-passing tests still pass (the composition root is only exercised via `main()` which tests don't call directly)

**Step 5: Commit**

```bash
git add src/index.ts
git commit -m "feat(web): conditionally register web tools in composition root"
```
<!-- END_TASK_4 -->
