# Runtime

Last verified: 2026-02-23

## Purpose
Executes agent-generated TypeScript code in a Deno subprocess sandbox with controlled permissions and an IPC bridge for tool calls back to the host.

## Contracts
- **Exposes**: `CodeRuntime` interface (`execute(code, toolStubs) -> ExecutionResult`), `createDenoExecutor(config, registry)`, IPC message types
- **Guarantees**:
  - Code size validated before execution (`max_code_size`)
  - Output size capped at `max_output_size`
  - Execution times out after `code_timeout` ms
  - Tool calls from sandbox limited to `max_tool_calls_per_exec`
  - Deno permissions: network only to `allowed_hosts`, filesystem only to `working_dir`, no subprocess/env/FFI access
  - Temporary script files are cleaned up after execution
- **Expects**: Deno installed and on PATH. `working_dir` exists. `ToolRegistry` populated with tools.

## Dependencies
- **Uses**: `src/tool/` (registry for IPC tool dispatch), `src/config/` (RuntimeConfig + AgentConfig)
- **Used by**: `src/agent/` (for `execute_code` tool dispatch)
- **Boundary**: `src/runtime/deno/runtime.ts` runs inside Deno (excluded from tsconfig). Everything else is Bun-side.

## IPC Protocol
Host (Bun) and sandbox (Deno) communicate via newline-delimited JSON on stdin/stdout:
- Deno -> Host: `__output__` (captured output), `__tool_call__` (invoke host tool), `__debug__`
- Host -> Deno: `__tool_result__`, `__tool_error__`

Tool stubs are generated by `ToolRegistry.generateStubs()` and injected into the Deno script. They call `__callTool__` which sends IPC messages and awaits responses.

## Key Decisions
- Deno over Node.js worker: Deno's permission system provides true sandboxing without container overhead
- IPC over HTTP: Lower latency for tool calls within the same machine
- User code wrapped in async IIFE with `Deno.exit(0)`: The stdin IPC listener keeps the event loop alive; explicit exit prevents subprocess hang

## Invariants
- The Deno subprocess never has broader permissions than configured
- All resource limits (size, time, call count) are enforced host-side, not trust-the-sandbox

## Key Files
- `types.ts` -- `CodeRuntime`, `ExecutionResult`, IPC message types
- `executor.ts` -- Deno subprocess management, IPC handling, resource enforcement
- `deno/runtime.ts` -- Deno-side IPC bridge (runs inside sandbox, excluded from tsconfig)
